[manifest]
version = "1.0.0"
dump_lua = true
priority = 0

# Sagatro mechanics
[[patches]]
[patches.pattern]
target = "functions/common_events.lua"
pattern = "if v.yes_pool_flag and not G.GAME.pool_flags[v.yes_pool_flag] then add = nil end"
position = "after"
payload = '''
if G.GAME.story_mode then
    if v.set == 'Joker' then
        -- Sagatro jokers only
        if not v.saga_group then add = nil end
        -- Events that would alter joker pool
        local story, interwoven, event = G.GAME.current_storyline, G.GAME.interwoven_storyline, G.GAME.saga_event_queue[1]
        if (story ~= "none" or interwoven) and event
        and (G.GAME.saga_spawn_table[story] or G.GAME.saga_spawn_table[interwoven or story])
        and (G.GAME.saga_spawn_table[story][event] or (G.GAME.saga_spawn_table[interwoven or story] or {})[event])
        and (type(G.GAME.saga_spawn_table[story][event]) == "table"
        or type((G.GAME.saga_spawn_table[interwoven or story] or {})[event]) == "table") then
            add = nil
            for _, key in ipairs(G.GAME.saga_spawn_table[story][event] or {}) do
                if not (G.GAME.used_jokers[v.key] and not pool_opts.allow_duplicates and not SMODS.showman(v.key))
                and v.unlocked ~= false and v.key == key then
                    add = true
                end
            end
            for _, key in ipairs((G.GAME.saga_spawn_table[interwoven or story] or {})[event] or {}) do
                if not (G.GAME.used_jokers[v.key] and not pool_opts.allow_duplicates and not SMODS.showman(v.key))
                and v.unlocked ~= false and v.key == key then
                    add = true
                end
            end
        end
    end
else
    if G.GAME.modifiers.sgt_disable_sagatro_items and v.mod and v.mod.id == "Sagatro" then
        add = nil
    end
end
'''
match_indent = true

[[patches]]
[patches.pattern]
target = "functions/common_events.lua"
pattern = '''
_pool[#_pool + 1] = 'UNAVAILABLE'
'''
position = "at"
payload = '''
if G.GAME.modifiers.sgt_disable_sagatro_items and v.mod and v.mod.id == "Sagatro" then
else
    _pool[#_pool + 1] = 'UNAVAILABLE'
end
'''
match_indent = true

[[patches]]
[patches.pattern]
target = "functions/common_events.lua"
pattern = '''elseif _type == 'Joker' then _pool[#_pool + 1] = "j_joker"'''
position = "at"
payload = '''
elseif _type == 'Joker' then
    if G.GAME.story_mode then
        if Sagatro.event_check("cry_into_flood") then
            _pool[#_pool + 1] = "j_splash"
        elseif Sagatro.event_check("goodbye_frog") then
            _pool[#_pool + 1] = "j_sgt_cheshire_cat"
        elseif Sagatro.event_check("mad_hatter") or next(Sagatro.find_active_card("j_sgt_mad_hatter", true)) then
            _pool[#_pool + 1] = "j_sgt_tea"
        elseif Sagatro.event_check("mirrorworld") then
            _pool[#_pool + 1] = "j_sgt_white_pawn"
        elseif Sagatro.storyline_check("20k_miles_under_the_sea") then
            _pool[#_pool + 1] = "j_sgt_seawater"
        else
            _pool[#_pool + 1] = "j_sgt_abducted_cow"
        end
    elseif next(Sagatro.find_active_card("j_sgt_mad_hatter")) then
        _pool[#_pool + 1] = "j_sgt_tea"
    -- This redundancy is to allow other mods to find the same pattern
    elseif _type == 'Joker' then _pool[#_pool + 1] = "j_joker"
    end
'''
match_indent = true

[[patches]]
[patches.pattern]
target = "functions/common_events.lua"
pattern = '''if _pool_size == 0 then'''
position = "before"
payload = '''
if _type == "Joker" and Sagatro.debug and _append then print(_pool_size.."/"..#_starting_pool, _pool_key) end
'''
match_indent = true

[[patches]]
[patches.pattern]
target = "functions/common_events.lua"
pattern = '''else _pool[#_pool + 1] = "j_joker"'''
position = "at"
payload = '''
else
    if G.GAME.story_mode then
        if Sagatro.event_check("cry_into_flood") then
            _pool[#_pool + 1] = "j_splash"
        elseif Sagatro.event_check("goodbye_frog") then
            _pool[#_pool + 1] = "j_sgt_cheshire_cat"
        elseif Sagatro.event_check("mad_hatter") or next(Sagatro.find_active_card("j_sgt_mad_hatter", true)) then
            _pool[#_pool + 1] = "j_sgt_tea"
        elseif Sagatro.event_check("mirrorworld") then
            _pool[#_pool + 1] = "j_sgt_white_pawn"
        elseif Sagatro.storyline_check("20k_miles_under_the_sea") then
            _pool[#_pool + 1] = "j_sgt_seawater"
        else
            _pool[#_pool + 1] = "j_sgt_abducted_cow"
        end
    elseif next(Sagatro.find_active_card("j_sgt_mad_hatter", true)) then
        _pool[#_pool + 1] = "j_sgt_tea"
    else _pool[#_pool + 1] = "j_joker"
    end
'''
match_indent = true

# Emult and score_mod
[[patches]]
[patches.pattern]
target = "functions/common_events.lua"
pattern = "local extrafunc = nil"
position = "after"
payload = '''
if eval_type == 'sgt_e_mult' then 
    sound = 'sgt_emult'
    volume = 0.7
    amt = amt
    text = '^' .. amt .. " " .. localize("k_mult")
    colour = G.C.DARK_EDITION
    config.type = 'fade'
    config.scale = 0.7
end
if eval_type == 'sgt_a_score' then 
    sound = 'sgt_bell_score'
    volume = 0.5
    amt = amt
    text = '+' .. amt .. " " .. localize("k_score")
    colour = G.C.DARK_EDITION
    config.type = 'fade'
    config.scale = 0.7
end
if eval_type == 'sgt_x_score' then 
    sound = 'sgt_bell_score'
    volume = 0.5
    amt = amt
    text = 'X' .. amt .. " " .. localize("k_score")
    colour = G.C.DARK_EDITION
    config.type = 'fade'
    config.scale = 0.7
end
if eval_type == 'sgt_e_score' then 
    sound = 'sgt_bell_score'
    volume = 0.5
    amt = amt
    text = '^' .. amt .. " " .. localize("k_score")
    colour = G.C.DARK_EDITION
    config.type = 'fade'
    config.scale = 0.7
end
if eval_type == 'sgt_ee_score' then 
    sound = 'sgt_bell_score'
    volume = 0.5
    amt = amt
    text = '^^' .. amt .. " " .. localize("k_score")
    colour = G.C.DARK_EDITION
    config.type = 'fade'
    config.scale = 0.7
end
if eval_type == 'sgt_eee_score' then 
    sound = 'sgt_bell_score'
    volume = 0.5
    amt = amt
    text = '^^^' .. amt .. " " .. localize("k_score")
    colour = G.C.DARK_EDITION
    config.type = 'fade'
    config.scale = 0.7
end
if eval_type == 'sgt_hyper_score' then 
    sound = 'sgt_bell_score'
    volume = 0.5
    text = ((amt[1] > 5 and ('{' .. amt[1] .. '}') or string.rep('^', amt[1])) .. amt[2]) .. " " .. localize("k_score")
    amt = amt[2]
    colour = G.C.DARK_EDITION
    config.type = 'fade'
    config.scale = 0.7
end
'''
match_indent = true

# The Cook patches (stolen from Bunco's Vandalism)
[[patches]]
[patches.pattern]
target = 'blind.lua'
pattern = '''if self.name == 'The Wheel' and SMODS.pseudorandom_probability(self, pseudoseed('wheel'), 1, 7, 'wheel') then'''
position = 'before'
match_indent = true
payload = '''
if G.jokers then
    for _, v in ipairs(Sagatro.find_active_card("j_sgt_the_cook")) do
        if v:can_calculate() then
            if (SMODS.pseudorandom_probability(v, 'thecook'..G.SEED, 1, v.ability.extra.odds, 'thecook')) and (G.STATE == G.STATES.SELECTING_HAND or G.STATE == G.STATES.DRAW_TO_HAND) then
                SMODS.calculate_context({sgt_stay_flipped = true})
                return true
            end
        end
    end
end
'''

[[patches]]
[patches.pattern]
target = 'functions/state_events.lua'
pattern = '''--check the hand first'''
position = 'after'
match_indent = true
payload = '''
if G.jokers then
    for _, v in ipairs(Sagatro.find_active_card("j_sgt_the_cook")) do
        SMODS.calculate_context({sgt_play_cards = true})
    end
end
'''

# Patches to disable Up the Ante
[[patches]]
[patches.regex]
target = 'functions/state_events.lua'
pattern = '''delay\(0\.4\);.* ease_ante\('''
position = 'before'
payload = '''if not Sagatro.stall_ante() then '''

[[patches]]
[patches.regex]
target = 'functions/state_events.lua'
pattern = '''G\.GAME\.round_resets\.ante \+ 1}\)'''
position = 'after'
payload = '''else SMODS.calculate_context({sgt_ante_interrupt = true}) end'''

[[patches]]
[patches.regex]
target = 'functions/UI_definitions.lua'
pattern = '''elseif [type == 'Boss' and ]*not run_info then'''
position = 'at'
payload = '''elseif type == 'Boss' and not run_info and not Sagatro.stall_ante() then'''

# Inverse scaling
[[patches]]
[patches.regex]
target = 'functions/UI_definitions.lua'
pattern = '''localize\('ph_blind_score_at_least'\)'''
position = 'at'
payload = '''G.GAME.inversed_scaling and localize('ph_blind_score_at_most') or localize('ph_blind_score_at_least')'''

[[patches]]
[patches.regex]
target = 'functions/UI_definitions.lua'
pattern = '''localize\('ph_blind_score_at_least'\), scale = 0\.3, colour = G\.C\.WHITE, shadow = true'''
position = 'at'
payload = '''localize('ph_blind_score_at_least'), scale = 0.3, colour = G.C.WHITE, shadow = true, id = "HUD_blind_score_at_least_most"'''

[[patches]]
[patches.regex]
target = 'functions/common_events.lua'
pattern = '''localize\('ph_score_at_least'\)'''
position = 'at'
payload = '''(G.GAME.inversed_scaling and localize('ph_blind_score_at_most') or localize('ph_score_at_least'))'''

[[patches]]
[patches.regex]
target = 'functions/UI_definitions.lua'
pattern = '''blind\.mult\.\.localize\('k_x_base'\)'''
position = 'at'
payload = '''G.GAME.inversed_scaling and number_format(1/math.max(blind.mult*((0.8+(0.05*math.log(blind.mult)))^blind.mult), 1))..localize('k_x_base') or blind.mult..localize('k_x_base')'''

[[patches]]
[patches.regex]
target = 'functions/UI_definitions.lua'
pattern = '''localize\('ph_up_ante_2'\)'''
position = 'at'
payload = '''G.GAME.inversed_scaling and localize('ph_up_ante_2_inverse') or localize('ph_up_ante_2')'''

[[patches]]
[patches.pattern]
target = 'functions/state_events.lua' # Non-Talisman
pattern = '''if G.GAME.chips - G.GAME.blind.chips >= 0 then'''
position = 'at'
match_indent = true
payload = '''
if (not G.GAME.inversed_scaling and to_big(G.GAME.chips) >= to_big(G.GAME.blind.chips))
or (G.GAME.inversed_scaling and to_big(G.GAME.chips) <= to_big(G.GAME.blind.chips)) then
'''

[[patches]]
[patches.pattern]
target = 'functions/state_events.lua' # Talisman
pattern = '''if to_big(G.GAME.chips) >= to_big(G.GAME.blind.chips) then'''
position = 'at'
match_indent = true
payload = '''
if (not G.GAME.inversed_scaling and to_big(G.GAME.chips) >= to_big(G.GAME.blind.chips))
or (G.GAME.inversed_scaling and to_big(G.GAME.chips) <= to_big(G.GAME.blind.chips)) then
'''

[[patches]]
[patches.pattern]
target = 'main.lua' # Talisman
pattern = '''if to_big(G.GAME.chips) >= to_big(G.GAME.blind.chips) then'''
position = 'at'
match_indent = true
payload = '''
if (not G.GAME.inversed_scaling and to_big(G.GAME.chips) >= to_big(G.GAME.blind.chips))
or (G.GAME.inversed_scaling and to_big(G.GAME.chips) <= to_big(G.GAME.blind.chips)) then
'''

# Double blind rewards in inverse mode
[[patches]]
[patches.pattern]
target = 'functions/state_events.lua'
pattern = '''if G.GAME.current_round.discards_left > 0 and G.GAME.modifiers.money_per_discard then'''
position = 'before'
match_indent = true
payload = '''
if G.GAME.current_round.discards_left > 0 and G.GAME.inversed_scaling then
    add_round_eval_row({dollars = G.GAME.current_round.discards_left, bonus='true', name='joker_inversed_score', card={config={center={set='Other', key='sgt_inverse_bonus'}}, juice_up=function(self) end}, pitch = pitch})
    pitch = pitch + 0.06
    dollars = dollars +  G.GAME.current_round.discards_left
end
'''

# Inverse blinds scale the other way
[[patches]]
[patches.pattern]
target = 'functions/UI_definitions.lua'
pattern = '''local blind_amt = get_blind_amount(G.GAME.round_resets.blind_ante)*blind_choice.config.mult*G.GAME.starting_params.ante_scaling'''
position = 'after'
match_indent = true
payload = '''
local final_mult = blind_choice.config.mult or 0
for k, v in pairs(G.GAME.modifiers.sgt_blind_mult_mod or {}) do
    if G.GAME.round_resets.blind_choices[k]
    and G.GAME.round_resets.blind_choices[k] == blind_choice.config.key then
        final_mult = final_mult * v
        break
    end
end
blind_amt = get_blind_amount(G.GAME.round_resets.blind_ante)*final_mult*G.GAME.starting_params.ante_scaling
if G.GAME.inversed_scaling then
    blind_amt = get_blind_amount(G.GAME.round_resets.ante)/math.max(final_mult*((0.8+(0.05*math.log(final_mult)))^final_mult), 1)
end
'''

# Allow fractional score in inverse
[[patches]]
[patches.regex]
target = 'functions/state_events.lua'
pattern = '''math\.floor\( SMODS\.calculate_round_score\(\) \)'''
position = 'at'
payload = '''(G.GAME.inversed_scaling and SMODS.calculate_round_score() or math.floor( SMODS.calculate_round_score() ))'''

[[patches]]
[patches.regex]
target = 'functions/state_events.lua'
pattern = '''math\.floor\(t\)'''
position = 'at'
payload = '''G.GAME.inversed_scaling and t or math.floor(t)'''

[[patches]]
[patches.pattern]
target = 'functions/button_callbacks.lua'
pattern = '''
G.GAME.current_round.current_hand.chip_total_text = ''
'''
position = 'at'
match_indent = true
payload = '''
if G.GAME.inversed_scaling and to_big(G.GAME.current_round.current_hand.chip_total) > to_big(0) then
  local new_chip_total_text = number_format(G.GAME.current_round.current_hand.chip_total)
  if new_chip_total_text ~= G.GAME.current_round.current_hand.chip_total_text then 
    e.config.object.scale = scale_number(G.GAME.current_round.current_hand.chip_total, 0.95, 100000000)
    
    G.GAME.current_round.current_hand.chip_total_text = new_chip_total_text
    if not G.ARGS.hand_chip_total_UI_set or to_big(G.ARGS.hand_chip_total_UI_set) < to_big(G.GAME.current_round.current_hand.chip_total) then
      G.FUNCS.text_super_juice(e, math.floor(math.log10(G.GAME.current_round.current_hand.chip_total)))
    end
    G.ARGS.hand_chip_total_UI_set = G.GAME.current_round.current_hand.chip_total
    --e.UIBox:recalculate()
  end
else
  G.GAME.current_round.current_hand.chip_total_text = ''
end
'''

# Proper number format
[[patches]]
[patches.pattern]
target = 'functions/misc_functions.lua'
pattern = '''if num < 0.01 then return tostring(num) end'''
position = 'at'
match_indent = true
payload = '''
if num < 0.01 then
  if num >= 1e-5 then
    formatted = string.format(num >= 1e-3 and "%.3f" or num >= 1e-4 and "%.4f" or "%.5f", num)
    if formatted:sub(-1) == "0" then
      formatted = formatted:gsub("%.?0+$", "")
    end
  else
    formatted = tostring(num)
    local e_pos, remaining1, remaining2
    for i = 1, #formatted do
      if formatted:sub(i, i) == "e" then
        e_pos = i
        break
      end
    end
    if e_pos > 5 then
      remaining1, remaining2 = formatted:sub(1, 4), formatted:sub(e_pos, #formatted)
      formatted = remaining1..remaining2
    end
    if formatted:sub(-2, -2) == "0" and formatted:sub(-3, -3) == "-" then
      formatted = formatted:reverse():gsub("0", "", 1):reverse()
    end
  end
  return sign..formatted
end
'''

# Handle blind dollar reward UI (stolen from Ortalab)
[[patches]]
[patches.pattern]
target = 'functions/UI_definitions.lua'
match_indent = true
position = 'at'
pattern = '''
{n=G.UIT.T, config={text = string.rep(localize("$"), blind_choice.config.dollars)..'+', scale = 0.35, colour = disabled and G.C.UI.TEXT_INACTIVE or G.C.MONEY, shadow = not disabled}}
'''
payload = '''
{n=G.UIT.T, config={text = blind_choice.config.dollars < 10 and string.rep(localize("$"), blind_choice.config.dollars)..'+' or localize("$")..blind_choice.config.dollars..'+', scale = 0.35, colour = disabled and G.C.UI.TEXT_INACTIVE or G.C.MONEY, shadow = not disabled}}
'''

[[patches]] # Ortalab doesn't have this one for some reason
[patches.pattern]
target = 'functions/UI_definitions.lua'
match_indent = true
position = 'at'
pattern = '''
{n=G.UIT.O, config={object = DynaText({string = {_dollars and string.rep(localize('$'),_dollars) or '-'}, colours = {G.C.MONEY}, rotate = true, bump = true, silent = true, scale = 0.45})}},
'''
payload = '''
{n=G.UIT.O, config={object = DynaText({string = {_dollars and (_dollars < 10 and string.rep(localize('$'),_dollars) or localize("$").._dollars) or '-'}, colours = {G.C.MONEY}, rotate = true, bump = true, silent = true, scale = 0.45})}},
'''

[[patches]]
[patches.pattern]
target = 'blind.lua'
match_indent = true
position = 'at'
pattern = '''
G.GAME.current_round.dollars_to_be_earned = self.dollars > 0 and (string.rep(localize('$'), self.dollars)..'') or ('')
'''
payload = '''
G.GAME.current_round.dollars_to_be_earned = self.dollars > 0 and (self.dollars < 10 and string.rep(localize('$'), self.dollars)..'' or localize('$')..self.dollars) or ('')
'''

# Force win if a certain showdown blind is defeated
[[patches]]
[patches.pattern]
target = 'functions/state_events.lua'
pattern = '''if G.GAME.round_resets.ante == G.GAME.win_ante and G.GAME.blind:get_type() == 'Boss' then'''
position = 'at'
match_indent = true
payload = '''
if (not G.GAME.story_mode and G.GAME.round_resets.ante >= G.GAME.win_ante and G.GAME.blind_on_deck == 'Boss')
or (G.GAME.story_mode and table.contains(Sagatro.story_mode_showdown, G.GAME.blind.config.blind.key) and not G.GAME.paused_showdown) then
'''

# Make losing after a certain showdown blind but before win Ante a valid endless run
[[patches]]
[patches.pattern]
target = 'game.lua'
pattern = '''if G.GAME.round_resets.ante <= G.GAME.win_ante then'''
position = 'at'
match_indent = true
payload = '''
if (not G.GAME.story_mode and G.GAME.round_resets.ante <= G.GAME.win_ante)
or (G.GAME.story_mode and not G.GAME.story_ended) then
'''

[[patches]]
[patches.pattern]
target = 'game.lua'
pattern = '''if G.GAME.round_resets.ante <= G.GAME.win_ante then --Only add Jimbo to say a quip if the game over happens when the run is lost'''
position = 'at'
match_indent = true
payload = '''
-- Only add Jimbo (or Alice if in story mode) to say a quip if the game over happens when the run is lost
if (not G.GAME.story_mode and G.GAME.round_resets.ante <= G.GAME.win_ante)
or (G.GAME.story_mode and not G.GAME.story_ended) then
'''

[[patches]]
[patches.pattern]
target = 'functions/UI_definitions.lua'
pattern = '''local eased_red = copy_table(G.GAME.round_resets.ante <= G.GAME.win_ante and G.C.RED or G.C.BLUE)'''
position = 'at'
match_indent = true
payload = '''
local eased_red = copy_table(((not G.GAME.story_mode and G.GAME.round_resets.ante <= G.GAME.win_ante)
or (G.GAME.story_mode and not G.GAME.story_ended)) and G.C.RED or G.C.BLUE)
'''

# Replace YOU WIN! with STORY ENDED! if Red Queen is defeated
[[patches]]
[patches.pattern]
target = 'functions/UI_definitions.lua'
pattern = '''{n=G.UIT.O, config={object = DynaText({string = {localize('ph_you_win')}, colours = {G.C.EDITION},shadow = true, float = true, spacing = 10, rotate = true, scale = 1.5, pop_in = 0.4, maxw = 6.5})}},'''
position = 'at'
match_indent = true
payload = '''
{n=G.UIT.O, config={object = DynaText({string = {G.GAME.story_mode and table.contains(Sagatro.story_mode_showdown, G.GAME.blind.config.blind.key) and localize('ph_story_ended') or localize('ph_you_win')}, colours = {G.C.EDITION},shadow = true, float = true, spacing = 10, rotate = true, scale = 1.5, pop_in = 0.4, maxw = 6.5})}},
'''

# Replace Jimbo with Alice (still allowing Joseph if Cryptid is also installed)
# Use SMODS.JimboQuip instead if it's present
[[patches]]
[patches.pattern]
target = "card_character.lua"
pattern = 'self.children.card.states.visible = false'
position = "before"
payload = '''
if SMODS and not SMODS.JimboQuip then
    self.children.card:set_ability(G.P_CENTERS[G.GAME.story_mode and "j_sgt_alice" or Cryptid and "j_jolly" or "j_joker"])
end
self.children.card:set_debuff(false)
'''
match_indent = true

[[patches]]
[patches.pattern]
target = "card_character.lua"
pattern = 'colours = {G.C.RED, G.C.BLUE, G.C.ORANGE},'
position = "at"
payload = '''
colours = G.GAME.story_mode
and {Sagatro.badge_colour, G.C.BLUE, G.C.RARITY[4]}
or {G.C.RED, G.C.BLUE, G.C.ORANGE},
'''
match_indent = true

[[patches]]
[patches.pattern]
target = "card_character.lua"
pattern = 'colours = {G.C.CRY_EXOTIC, G.C.BLUE, G.C.CRY_JOLLY},'
position = "at" # Overrides Cryptid
payload = '''
colours = G.GAME.story_mode
and {Sagatro.badge_colour, G.C.BLUE, G.C.RARITY[4]}
or {G.C.CRY_EXOTIC, G.C.BLUE, G.C.CRY_JOLLY},
'''
match_indent = true

# Alice invades Splash screen
[[patches]]
[patches.pattern]
target = "game.lua"
pattern = "SC = Card(G.ROOM.T.w/2 - SC_scale*G.CARD_W/2, 10. + G.ROOM.T.h/2 - SC_scale*G.CARD_H/2, SC_scale*G.CARD_W, SC_scale*G.CARD_H, G.P_CARDS.empty, G.P_CENTERS['j_joker'])"
position = "after"
payload = '''
SC = Card(G.ROOM.T.w/2 - SC_scale*G.CARD_W/2, 10. + G.ROOM.T.h/2 - SC_scale*G.CARD_H/2, SC_scale*G.CARD_W, SC_scale*G.CARD_H, G.P_CARDS.empty, G.P_CENTERS['j_sgt_alice'],{bypass_discovery_center = true, bypass_discovery_ui = true})
'''
match_indent = true

# Add a "Delete Ace" button in options in menu
[[patches]]
[patches.pattern]
target = "functions/UI_definitions.lua"
pattern = '''
if G.STAGE == G.STAGES.MAIN_MENU then
  credits = UIBox_button{ label = {localize('b_credits')}, button = "show_credits", minw = 5}
end
'''
position = "at"
payload = '''
local delete_ace = nil

if G.STAGE == G.STAGES.MAIN_MENU then
  credits = UIBox_button{ label = {localize('b_credits')}, button = "show_credits", minw = 5}
  delete_ace = UIBox_button{id = 'sgt_delete_ace', label = {localize('b_delete_ace')}, button = "delete_ace_in_menu", minw = 5}
end
'''
match_indent = true

[[patches]]
[patches.pattern]
target = "functions/UI_definitions.lua"
pattern = '''
customize,
credits
'''
position = "at"
payload = '''
customize,
credits,
delete_ace
'''
match_indent = true

# I don't like buffed Aladdin evaluating G.C.BLUE with Xmult sfx
[[patches]]
[patches.pattern]
target = "functions/common_events.lua"
pattern = '''
end
if extra.chip_mod or extra.Xchip_mod then
'''
position = "at"
payload = '''
elseif extra.chip_mod or extra.Xchip_mod then
'''
match_indent = true

[[patches]]
[patches.pattern]
target = "functions/common_events.lua"
pattern = '''
if not extra.edition and (extra.mult_mod or extra.Xmult_mod)  then
    colour = G.C.MULT
'''
position = "after"
payload = '''
    config.type = 'fall'
    config.scale = 0.7
'''
match_indent = true

# Pufferfish debuffing adjacent jokers would be too dangerous if it constantly debuffs and undebuffs jokers that add hand size
# This patch aims to fix that, but also removes Beanstalk trick to get naneinf
[[patches]]
[patches.pattern]
target = "cardarea.lua"
pattern = '''
if delta > 0 and self.config.real_card_limit > 1 and self == G.hand and self.cards[1] and (G.STATE == G.STATES.DRAW_TO_HAND or G.STATE == G.STATES.SELECTING_HAND) then 
    local card_count = math.abs(delta)
'''
position = "at"
payload = '''
if delta > 0 and self.config.real_card_limit > 1 and self == G.hand and self.cards[1]
and (G.STATE == G.STATES.DRAW_TO_HAND or G.STATE == G.STATES.SELECTING_HAND)
and #self.cards < self.config.card_limit then
    local card_count = self.config.card_limit - #self.cards
'''
match_indent = true

# Custom background colour in story mode
[[patches]]
[patches.pattern]
target = "functions/common_events.lua"
pattern = '''elseif G.GAME.won then '''
position = "before"
payload = '''
elseif G.GAME.story_mode and next(Sagatro.find_active_card("j_sgt_submarine", true)) then
    ease_background_colour{new_colour = G.C.SUBMARINE_DEPTH[Sagatro.get_submarine_depth_colour()], contrast = 1}
elseif G.GAME.story_mode and G.GAME.inversed_scaling then
    ease_background_colour{new_colour = mix_colours(G.C.GREY, G.C.WHITE, 0.5), contrast = 1}
'''
match_indent = true

# Force boss blinds if Ragnarok is present
[[patches]]
[patches.pattern]
target = "functions/common_events.lua"
pattern = '''G.GAME.round_resets.blind_choices.Boss = get_new_boss()'''
position = "at"
payload = '''
if next(Sagatro.find_active_card("j_sgt_ragnarok")) then
    local small_hide = G.GAME.round_resets.blind_states.Small == 'Hide'
    local big_hide = G.GAME.round_resets.blind_states.Big == 'Hide'
    G.GAME.round_resets.blind_choices.Small = not small_hide and get_new_boss('not_forced')
    G.GAME.round_resets.blind_choices.Big = not big_hide and get_new_boss('not_forced')
    G.GAME.round_resets.blind_choices.Boss = Sagatro.get_new_showdown(not G.GAME.story_mode and 'not_forced')
else
    G.GAME.round_resets.blind_choices.Small = 'bl_small'
    G.GAME.round_resets.blind_choices.Big = 'bl_big'
    G.GAME.round_resets.blind_choices.Boss = get_new_boss()
end
'''
match_indent = true

[[patches]]
[patches.pattern]
target = "functions/button_callbacks.lua"
pattern = '''G.GAME.round_resets.blind_choices.Boss = get_new_boss()'''
position = "at"
payload = '''
if next(Sagatro.find_active_card("j_sgt_ragnarok")) then
  G.GAME.round_resets.blind_choices.Boss = Sagatro.get_new_showdown(not G.GAME.story_mode and 'not_forced')
else
  G.GAME.round_resets.blind_choices.Boss = get_new_boss()
end
'''
match_indent = true

# Patches to make sure defeating bosses replacing Small/Big Blind won't increment Ante or reset blind states
[[patches]]
[patches.pattern]
target = "functions/state_events.lua"
pattern = "if G.GAME.blind:get_type() == 'Boss' then"
position = "at"
payload = "if G.GAME.blind_on_deck == 'Boss' then"
match_indent = true

[[patches]]
[patches.pattern]
target = "functions/state_events.lua"
pattern = "if G.GAME.round_resets.blind == G.P_BLINDS.bl_small then"
position = "at"
payload = "if G.GAME.blind_on_deck == 'Small' then"
match_indent = true

[[patches]]
[patches.pattern]
target = "functions/state_events.lua"
pattern = "elseif G.GAME.round_resets.blind == G.P_BLINDS.bl_big then"
position = "at"
payload = "elseif G.GAME.blind_on_deck == 'Big' then"
match_indent = true

[[patches]]
[patches.pattern]
target = "functions/state_events.lua"
pattern = "if G.GAME.round_resets.ante == G.GAME.win_ante and G.GAME.blind:get_type() == 'Boss' then"
position = "at"
payload = "if G.GAME.round_resets.ante >= G.GAME.win_ante and G.GAME.blind_on_deck == 'Boss' then"
match_indent = true

# Challenge-related patches
[[patches]]
[patches.regex]
target = "functions/UI_definitions.lua"
pattern = "if type == 'Small' "
position = "after"
payload = "and not G.GAME.modifiers.sgt_no_tags "

[[patches]]
[patches.regex]
target = "functions/UI_definitions.lua"
pattern = "elseif type == 'Big' "
position = "after"
payload = "and not G.GAME.modifiers.sgt_no_tags "

# Omnicient behaves like every vanilla enhancement
[[patches]]
[patches.pattern]
target = "card.lua"
pattern = "-- TARGET: get_chip_mult"
position = "after"
payload = '''
if self.ability.effect == "Omnicient" then
    self.lucky_trigger = true
end
'''
match_indent = true

[[patches]]
[patches.regex]
target = "card.lua"
pattern = '''SMODS\.has_enhancement'''
position = "at"
payload = '''Sagatro.omniscient'''

# Upgraded enhancements behave like their original counterparts
[[patches]]
[patches.regex]
target = "card.lua"
pattern = "'m_glass'"
position = "at"
payload = "{'m_glass', 'm_sgt_nyx_glass'}"

[[patches]]
[patches.regex]
target = "card.lua"
pattern = "'m_steel'"
position = "at"
payload = "{'m_steel', 'm_sgt_titanium'}"

[[patches]]
[patches.regex]
target = "card.lua"
pattern = "'m_stone'"
position = "at"
payload = "{'m_stone', 'm_sgt_abyss_stone'}"

[[patches]]
[patches.regex]
target = "card.lua"
pattern = "'m_gold'"
position = "at"
payload = "{'m_gold', 'm_sgt_platinum'}"

# Damn you Incantation for completely overriding set_consumeable_usage, I'm moving to Overflow
[[patches]]
[patches.pattern]
target = "functions/misc_functions.lua"
pattern = "G.GAME.consumeable_usage_total = G.GAME.consumeable_usage_total or {tarot = 0, planet = 0, spectral = 0, tarot_planet = 0, all = 0}"
position = "after"
payload = '''
-- G.GAME.consumeable_usage_total.tarot_planet_divinatio_celestara = G.GAME.consumeable_usage_total.tarot_planet_divinatio_celestara or 0
-- if card.config.center.set == 'Tarot' or card.config.center.set == 'Planet'
-- or card.config.center.set == 'Divinatio' or card.config.center.set == 'Celestara' then
--   G.GAME.consumeable_usage_total.tarot_planet_divinatio_celestara = G.GAME.consumeable_usage_total.tarot_planet_divinatio_celestara + 1
-- end
if card.config.center.set == 'Tarot' or card.config.center.set == 'Planet'
or (card.config.center.set == 'Divinatio' and card.config.center_key ~= 'c_sgt_anima')
or (card.config.center.set == 'Celestara' and card.config.center_key ~= 'c_sgt_soltera') then
  G.E_MANAGER:add_event(Event({
    trigger = 'immediate',
    func = function()
    G.E_MANAGER:add_event(Event({
      trigger = 'immediate',
      func = function()
        G.GAME.last_tarot_planet_divinatio_celestara = card.config.center_key
      return true
      end
    }))
    return true
    end
  }))
end

'''
match_indent = true

# Ortalab collab... Ig?
[[patches]]
[patches.pattern]
target = '=[SMODS ortalab "util/menu.lua"]'
pattern = '''
G.SPLASH_LOGO = Sprite(0, 0, 
    13*SC_scale, 
    13*SC_scale*(G.ASSET_ATLAS[Ortalab.config.menu_toggle and 'ortalab_logo' or "balatro"].py/G.ASSET_ATLAS[Ortalab.config.menu_toggle and 'ortalab_logo' or "balatro"].px),
    G.ASSET_ATLAS[Ortalab.config.menu_toggle and 'ortalab_logo' or "balatro"], {x=0,y=0})
'''
position = "at"
payload = '''
G.SPLASH_LOGO = Sprite(0, 0, 
    13*SC_scale, 
    13*SC_scale*(G.ASSET_ATLAS[Ortalab.config.menu_toggle and 'ortalab_'..(Sagatro.config.Ortagas and 'alt_' or '')..'logo' or "balatro"].py/G.ASSET_ATLAS[Ortalab.config.menu_toggle and 'ortalab_'..(Sagatro.config.Ortagas and 'alt_' or '')..'logo' or "balatro"].px),
    G.ASSET_ATLAS[Ortalab.config.menu_toggle and 'ortalab_'..(Sagatro.config.Ortagas and 'alt_' or '')..'logo' or "balatro"], {x=0,y=0})
'''
match_indent = true

[[patches]]
[patches.pattern]
target = 'game.lua'
pattern = '''
G.SPLASH_LOGO = Sprite(0, 0, 
    13*SC_scale, 
    13*SC_scale*(G.ASSET_ATLAS[Ortalab.config.menu_toggle and 'ortalab_logo' or "balatro"].py/G.ASSET_ATLAS[Ortalab.config.menu_toggle and 'ortalab_logo' or "balatro"].px),
    G.ASSET_ATLAS[Ortalab.config.menu_toggle and 'ortalab_logo' or "balatro"], {x=0,y=0})
'''
position = "at"
payload = '''
G.SPLASH_LOGO = Sprite(0, 0, 
    13*SC_scale, 
    13*SC_scale*(G.ASSET_ATLAS[Ortalab.config.menu_toggle and 'ortalab_'..(Sagatro.config.Ortagas and 'alt_' or '')..'logo' or "balatro"].py/G.ASSET_ATLAS[Ortalab.config.menu_toggle and 'ortalab_'..(Sagatro.config.Ortagas and 'alt_' or '')..'logo' or "balatro"].px),
    G.ASSET_ATLAS[Ortalab.config.menu_toggle and 'ortalab_'..(Sagatro.config.Ortagas and 'alt_' or '')..'logo' or "balatro"], {x=0,y=0})
'''
match_indent = true

# Patch to softlock Celestara cards for secret hands
[[patches]]
[patches.pattern]
target = 'functions/common_events.lua'
pattern = '''
elseif v.set == 'Planet' then
'''
position = "before"
payload = '''
elseif v.set == 'Celestara' then
    if (not v.config.softlock or G.GAME.hands[v.config.hand_type].played > 0) then
        add = true
    end
'''
match_indent = true

# No reshuffle fish effect (definitely ~~not~~ from Ortalab :P)
[[patches]]
[patches.pattern]
target = 'functions/state_events.lua'
match_indent = true
position = 'at'
pattern = '''
G.FUNCS.draw_from_discard_to_deck()
'''
payload = '''
if G.GAME.round_resets.blind_states.Boss ~= 'Current' and G.GAME.fish_effect.no_reshuffle then
else
    G.FUNCS.draw_from_discard_to_deck()
end
'''

# Imminent doom
[[patches]]
[patches.pattern]
target = 'functions/state_events.lua'
pattern = '''-- TARGET: main end_of_round evaluation'''
position = 'after'
match_indent = true
payload = '''
if G.GAME.story_mode and ((G.GAME.blind.boss and G.GAME.imminent_doom) or Sagatro.event_check("game_over")) then
    game_over = true
end
'''

# Make sure Ankh won't copy Submarine/Mirror
[[patches]]
[patches.pattern]
target = 'card.lua'
pattern = '''local chosen_joker = pseudorandom_element(G.jokers.cards, pseudoseed('ankh_choice'))'''
position = 'after'
match_indent = true
payload = '''
while G.GAME.story_mode and (chosen_joker.config.center_key == "j_sgt_submarine"
or chosen_joker.config.center_key == "j_sgt_mirror") do
    chosen_joker = pseudorandom_element(G.jokers.cards, pseudoseed('ankh_choice_reroll'))
end
'''

# Reroll-switch doesn't trigger save
[[patches]]
[patches.pattern]
target = "functions/button_callbacks.lua"
pattern = '''G.E_MANAGER:add_event(Event({ func = function() save_run(); return true end}))'''
position = "at"
payload = '''
if not Sagatro.reroll_no_save then
  G.E_MANAGER:add_event(Event({ func = function() save_run(); return true end}))
end
'''
match_indent = true

# Overscore instead of no-score in inversion
[[patches]]
[patches.pattern]
target = "functions/state_events.lua"
pattern = '''
mult = mod_mult(0)
hand_chips = mod_chips(0)
'''
position = "after"
payload = '''
if G.GAME.inversed_scaling then
    mult = mod_mult(1)
    hand_chips = mod_chips(math.max(G.GAME.blind.chips*1.1, 1))
end
'''
match_indent = true

[[patches]]
[patches.regex]
target = "game.lua"
pattern = '''localize\('ph_unscored_hand'\)'''
position = "at"
payload = '''G.GAME.inversed_scaling and localize('ph_overscored_hand') or localize('ph_unscored_hand')'''
match_indent = true

# Jubjub bird effect
[[patches]]
[patches.pattern]
target = "functions/button_callbacks.lua"
pattern = '''G.STATE = G.STATES.SHOP'''
position = "at"
payload = '''
if G.GAME.jjb_cash_out and (next(Sagatro.find_active_card("j_sgt_jubjub_bird")) or Sagatro.vorpal_jubjub()) then
  G.FUNCS.cash_out_into_boss_blind()
else
  G.STATE = G.STATES.SHOP
end
'''
match_indent = true

[[patches]]
[patches.pattern]
target = "functions/button_callbacks.lua"
pattern = '''
G.GAME.shop_d6ed = nil
G.STATE_COMPLETE = false
'''
position = "at"
payload = '''
G.GAME.shop_d6ed = nil
if not (G.GAME.jjb_cash_out and (next(Sagatro.find_active_card("j_sgt_jubjub_bird")) or Sagatro.vorpal_jubjub())) then
  G.STATE_COMPLETE = false
end
'''
match_indent = true

[[patches]]
[patches.pattern]
target = "functions/button_callbacks.lua"
pattern = "if G.GAME.round_resets.blind_states.Boss == 'Defeated' then "
position = "before"
payload = '''
if G.GAME.jjb_cash_out and (next(Sagatro.find_active_card("j_sgt_jubjub_bird")) or Sagatro.vorpal_jubjub()) then
  G.GAME.round_resets.blind_states.Boss = 'Current'
  SMODS.calculate_context{sgt_jjb_reduction = true}
end
'''
match_indent = true

# Move seed generation to be before Back:apply and Stake.modifiers() so that both methods can use the seed and true pseudorandom numbers
# (Copied over from CardSleeves as a fallback if it's not installed)
[[patches]]
[patches.pattern]
target = "game.lua"
pattern = '''
if not saveTable then
    if args.seed then self.GAME.seeded = true end
    self.GAME.pseudorandom.seed = args.seed or (not (G.SETTINGS.tutorial_complete or G.SETTINGS.tutorial_progress.completed_parts['big_blind']) and "TUTORIAL") or generate_starting_seed()
end

for k, v in pairs(self.GAME.pseudorandom) do if v == 0 then self.GAME.pseudorandom[k] = pseudohash(k..self.GAME.pseudorandom.seed) end end
self.GAME.pseudorandom.hashed_seed = pseudohash(self.GAME.pseudorandom.seed)
'''
match_indent = true
position = "at"
payload = '''
-- moved this code to earlier in the function (by Sagatro)
--[[
if not saveTable then
    if args.seed then self.GAME.seeded = true end
    self.GAME.pseudorandom.seed = args.seed or (not (G.SETTINGS.tutorial_complete or G.SETTINGS.tutorial_progress.completed_parts['big_blind']) and "TUTORIAL") or generate_starting_seed()
end

for k, v in pairs(self.GAME.pseudorandom) do if v == 0 then self.GAME.pseudorandom[k] = pseudohash(k..self.GAME.pseudorandom.seed) end end
self.GAME.pseudorandom.hashed_seed = pseudohash(self.GAME.pseudorandom.seed)
--]]
'''

[[patches]]
[patches.pattern]
target = "game.lua"
pattern = '''self.GAME.selected_back_key = selected_back'''
match_indent = true
position = "after"
payload = '''

if not CardSleeves then
    if not saveTable then
        if args.seed then self.GAME.seeded = true end
        self.GAME.pseudorandom.seed = args.seed or (not (G.SETTINGS.tutorial_complete or G.SETTINGS.tutorial_progress.completed_parts["big_blind"]) and "TUTORIAL") or generate_starting_seed()
    end
    for k, v in pairs(self.GAME.pseudorandom) do if v == 0 then self.GAME.pseudorandom[k] = pseudohash(k..self.GAME.pseudorandom.seed) end end
    self.GAME.pseudorandom.hashed_seed = pseudohash(self.GAME.pseudorandom.seed)
end
'''

# Card UI patch (this cannot be a hook and I hate it)
[[patches]]
[patches.pattern]
target = "card.lua"
pattern = "return generate_card_ui(self.config.center, nil, loc_vars, card_type, badges, hide_desc, main_start, main_end, self)"
position = "before"
payload = '''
if G.GAME.modifiers.sgt_joker_selling_rounds and self.ability.sgt_selling_tally
and self.ability.sgt_selling_tally < G.GAME.modifiers.sgt_joker_selling_rounds
and not SMODS.is_eternal(self) and self.ability.set == "Joker" then
    loc_vars = loc_vars or {}; loc_vars.sgt_selling_tally = self.ability.sgt_selling_tally
    badges[#badges+1] = 'delayed_selling'
end

'''
match_indent = true

[[patches]]
[patches.pattern]
target = "functions/common_events.lua"
pattern = "if v == 'eternal' then info_queue[#info_queue+1] = {key = 'eternal', set = 'Other'} end"
position = "before"
payload = '''
if v == 'delayed_selling' then
    info_queue[#info_queue+1] = {set = "Other", key = "sgt_joker_selling_rounds",
    vars = {G.GAME.modifiers.sgt_joker_selling_rounds, specific_vars.sgt_selling_tally or 0}}
end

'''
match_indent = true

# Alternative Purple Stake shows rerolls remaining
[[patches]]
[patches.pattern]
target = "functions/UI_definitions.lua"
pattern = '''
{n=G.UIT.T, config={text = localize('k_reroll'), scale = 0.4, colour = G.C.WHITE, shadow = true}},
'''
position = "after"
payload = '''
G.GAME.modifiers.sgt_reroll_limit and {n=G.UIT.T, config={text = ' (', scale = 0.4, colour = G.C.WHITE, shadow = true}} or nil,
G.GAME.modifiers.sgt_reroll_limit and {n=G.UIT.T, config={ref_table = G.GAME.current_round, ref_value = 'rerolls_left', scale = 0.4, colour = G.C.WHITE, shadow = true}} or nil,
G.GAME.modifiers.sgt_reroll_limit and {n=G.UIT.T, config={text = ')', scale = 0.4, colour = G.C.WHITE, shadow = true}} or nil,
'''
match_indent = true

[[patches]]
[patches.pattern]
target = "functions/button_callbacks.lua"
pattern = "calculate_reroll_cost(final_free)"
position = "before"
payload = '''
G.GAME.current_round.reroll_count = G.GAME.current_round.reroll_count + 1
if G.GAME.modifiers.sgt_reroll_limit then
    G.GAME.current_round.rerolls_left = G.GAME.current_round.rerolls_left - 1
end
'''
match_indent = true